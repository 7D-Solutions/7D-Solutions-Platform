name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate-contracts:
    name: Validate Contracts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate YAML contracts
        run: |
          python3 -c "
          import yaml
          import sys
          from pathlib import Path
          
          errors = []
          for f in Path('contracts').rglob('*.yaml'):
              try:
                  yaml.safe_load(f.read_text())
                  print(f'✓ {f}')
              except Exception as e:
                  errors.append(f'✗ {f}: {e}')
          
          if errors:
              for e in errors:
                  print(e, file=sys.stderr)
              sys.exit(1)
          "
      
      - name: Validate JSON contracts
        run: |
          python3 -c "
          import json
          import sys
          from pathlib import Path
          
          errors = []
          for f in Path('contracts').rglob('*.json'):
              try:
                  json.loads(f.read_text())
                  print(f'✓ {f}')
              except Exception as e:
                  errors.append(f'✗ {f}: {e}')
          
          if errors:
              for e in errors:
                  print(e, file=sys.stderr)
              sys.exit(1)
          "

  validate-module-structure:
    name: Validate Module Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check VERSION and CHANGELOG exist
        run: |
          missing=()

          for module in platform/identity-auth modules/ar modules/subscriptions modules/payments modules/notifications modules/gl; do
            if [ ! -f "$module/VERSION" ]; then
              missing+=("$module/VERSION")
            fi
            if [ ! -f "$module/CHANGELOG.md" ]; then
              missing+=("$module/CHANGELOG.md")
            fi
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "ERROR: Missing required files:" >&2
            printf '%s\n' "${missing[@]}" >&2
            exit 1
          fi

          echo "✓ All modules have VERSION and CHANGELOG.md"

  contract-tests:
    name: Contract Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-contract-tests-${{ hashFiles('tools/contract-tests/Cargo.lock') }}

      - name: Run contract tests
        working-directory: tools/contract-tests
        run: cargo test --verbose

  cross-module-boundary-guard:
    name: Cross-Module Boundary Guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for illegal cross-module source imports
        run: |
          violations=()
          
          # AR must not reference AUTH source paths
          if grep -r "platform/identity-auth/src" modules/ar/src/ 2>/dev/null; then
            violations+=("AR references AUTH source code")
          fi
          
          # AUTH must not reference AR source paths
          if grep -r "modules/ar/src" platform/identity-auth/src/ 2>/dev/null; then
            violations+=("AUTH references AR source code")
          fi
          
          if [ ${#violations[@]} -gt 0 ]; then
            echo "ERROR: Cross-module boundary violations detected:" >&2
            printf '%s\n' "${violations[@]}" >&2
            exit 1
          fi
          
          echo "✓ No cross-module source code dependencies"
      
      - name: Check for illegal cross-module Cargo path dependencies
        run: |
          violations=()

          # ARCHITECTURE RULE: modules → platform is ALLOWED
          #                    modules → modules is PROHIBITED

          # Check all modules for dependencies to OTHER modules (not platform)
          for module in modules/*/Cargo.toml; do
            module_name=$(basename $(dirname "$module"))

            # Check if this module depends on OTHER modules (not platform)
            # Look for: path = "../../modules/OTHER_MODULE" or path = "../OTHER_MODULE"
            if grep -n 'path = .*\.\./\.\.modules/' "$module" 2>/dev/null; then
              violations+=("$module_name has cross-module dependency to another module")
            fi
            if grep -n 'path = .*\.\./[a-z-]*"' "$module" 2>/dev/null | grep -v '\.\./\.\.platform' | grep -v '\.\./src'; then
              violations+=("$module_name may have cross-module dependency")
            fi
          done

          # Check platform modules don't depend on business modules
          for platform_mod in platform/*/Cargo.toml; do
            if [ -f "$platform_mod" ]; then
              plat_name=$(basename $(dirname "$platform_mod"))
              if grep -n 'path = .*modules/' "$platform_mod" 2>/dev/null; then
                violations+=("Platform $plat_name depends on business module (prohibited)")
              fi
            fi
          done

          if [ ${#violations[@]} -gt 0 ]; then
            echo "ERROR: Cross-module Cargo path dependencies detected:" >&2
            printf '%s\n' "${violations[@]}" >&2
            echo "" >&2
            echo "ARCHITECTURE RULES:" >&2
            echo "  ✓ modules → platform  (ALLOWED)" >&2
            echo "  ✗ modules → modules   (PROHIBITED - use contracts)" >&2
            echo "  ✗ platform → modules  (PROHIBITED - platform must be generic)" >&2
            exit 1
          fi

          echo "✓ No prohibited cross-module Cargo path dependencies"
      
      - name: Check migration boundaries
        run: |
          chmod +x tools/check_migration_boundaries.sh
          ./tools/check_migration_boundaries.sh

  build-auth:
    name: Build AUTH Module
    runs-on: ubuntu-latest
    needs: [contract-tests]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-auth-${{ hashFiles('platform/identity-auth/Cargo.lock') }}
      
      - name: Run cargo check
        working-directory: platform/identity-auth
        run: cargo check --all-targets

  build-ar:
    name: Build AR Module
    runs-on: ubuntu-latest
    needs: [contract-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-ar-${{ hashFiles('modules/ar/Cargo.lock') }}

      - name: Run cargo check
        working-directory: modules/ar
        run: cargo check --all-targets

  build-subscriptions:
    name: Build Subscriptions Module
    runs-on: ubuntu-latest
    needs: [contract-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-subscriptions-${{ hashFiles('modules/subscriptions/Cargo.lock') }}

      - name: Run cargo check
        working-directory: modules/subscriptions
        run: cargo check --all-targets

  build-payments:
    name: Build Payments Module
    runs-on: ubuntu-latest
    needs: [contract-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-payments-${{ hashFiles('modules/payments/Cargo.lock') }}

      - name: Run cargo check
        working-directory: modules/payments
        run: cargo check --all-targets

  build-notifications:
    name: Build Notifications Module
    runs-on: ubuntu-latest
    needs: [contract-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-notifications-${{ hashFiles('modules/notifications/Cargo.lock') }}

      - name: Run cargo check
        working-directory: modules/notifications
        run: cargo check --all-targets

  build-gl:
    name: Build GL Module
    runs-on: ubuntu-latest
    needs: [contract-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-gl-${{ hashFiles('modules/gl/Cargo.lock') }}

      - name: Run cargo check
        working-directory: modules/gl
        run: cargo check --all-targets

  lint-no-panic:
    name: Lint - No Unwrap/Expect in Critical Paths
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for .unwrap() and .expect() in critical files
        run: |
          violations=()

          # Check consumer files
          if grep -rn '\.unwrap()\|\.expect(' modules/*/src/consumer* 2>/dev/null; then
            violations+=("Found .unwrap() or .expect() in consumer files")
          fi

          # Check events files
          if grep -rn '\.unwrap()\|\.expect(' modules/*/src/events/ 2>/dev/null; then
            violations+=("Found .unwrap() or .expect() in events files")
          fi

          # Check DLQ files
          if grep -rn '\.unwrap()\|\.expect(' modules/*/src/dlq* 2>/dev/null; then
            violations+=("Found .unwrap() or .expect() in DLQ files")
          fi

          if [ ${#violations[@]} -gt 0 ]; then
            echo "ERROR: Panic-prone code detected in critical paths:" >&2
            printf '%s\n' "${violations[@]}" >&2
            echo "" >&2
            echo "Critical paths (consumer, events, dlq) must handle errors gracefully." >&2
            echo "Use Result types and proper error propagation instead of .unwrap()/.expect()." >&2
            exit 1
          fi

          echo "✓ No .unwrap() or .expect() in critical paths"

  check-dlq-migrations:
    name: Check DLQ Migrations Exist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify all modules have DLQ migrations
        run: |
          missing=()

          for module in modules/ar modules/subscriptions modules/payments modules/notifications modules/gl; do
            if ! find "$module/db/migrations" -name "*failed_events*" 2>/dev/null | grep -q .; then
              missing+=("$module is missing DLQ (failed_events) migration")
            fi
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "ERROR: Missing DLQ migrations:" >&2
            printf '%s\n' "${missing[@]}" >&2
            echo "" >&2
            echo "All modules must have a DLQ migration (failed_events table)." >&2
            echo "See docs/architecture/DEPLOYMENT-RUNBOOK.md for DLQ schema." >&2
            exit 1
          fi

          echo "✓ All modules have DLQ migrations"

  e2e-happy-path:
    name: E2E Test - Happy Path
    runs-on: ubuntu-latest
    needs: [build-ar, build-subscriptions, build-payments, build-notifications, build-gl]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create external Docker resources
        run: |
          docker network create 7d-platform || true
          docker volume create 7d-nats-data || true
          docker volume create 7d-ar-pgdata || true
          docker volume create 7d-subscriptions-pgdata || true
          docker volume create 7d-payments-pgdata || true
          docker volume create 7d-notifications-pgdata || true

      - name: Start infrastructure
        run: |
          docker compose -f docker-compose.infrastructure.yml up -d
          sleep 10

      - name: Build and start modules
        run: |
          docker compose -f docker-compose.modules.yml build
          docker compose -f docker-compose.modules.yml up -d
          sleep 30

      - name: Wait for services to be healthy
        run: |
          timeout 120 bash -c '
            until docker compose -f docker-compose.modules.yml ps | grep -q "(healthy)"; do
              echo "Waiting for services to be healthy..."
              sleep 5
            done
          '

      - name: Run happy path E2E test
        working-directory: e2e-tests
        run: cargo test --test real_e2e -- --test-threads=1 --nocapture
        env:
          RUST_LOG: info

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== AR Logs ==="
          docker logs 7d-ar || true
          echo "=== Payments Logs ==="
          docker logs 7d-payments || true
          echo "=== Subscriptions Logs ==="
          docker logs 7d-subscriptions || true
          echo "=== Notifications Logs ==="
          docker logs 7d-notifications || true
          echo "=== GL Logs ==="
          docker logs gl-rs || true

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.modules.yml down || true
          docker compose -f docker-compose.infrastructure.yml down || true

  e2e-phase10-governance:
    name: E2E Test - Phase 10 Governance
    runs-on: ubuntu-latest
    needs: [build-gl]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create external Docker resources
        run: |
          docker network create 7d-platform || true
          docker volume create 7d-nats-data || true
          docker volume create 7d-gl-pgdata || true

      - name: Start infrastructure
        run: |
          docker compose -f docker-compose.infrastructure.yml up -d
          sleep 10

      - name: Build and start GL module
        run: |
          docker compose -f docker-compose.modules.yml build gl-rs
          docker compose -f docker-compose.modules.yml up -d gl-rs gl-postgres nats
          sleep 15

      - name: Wait for GL service to be healthy
        run: |
          timeout 60 bash -c '
            until curl -f http://localhost:8090/api/health 2>/dev/null; do
              echo "Waiting for GL service to be healthy..."
              sleep 2
            done
          '
          echo "✓ GL service is healthy"

      - name: Run Phase 10 governance E2E tests
        working-directory: e2e-tests
        run: cargo test --test phase10_governance_e2e -- --ignored --test-threads=1 --nocapture
        env:
          RUST_LOG: info

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== GL Logs ==="
          docker logs gl-rs || true
          echo "=== GL Postgres Logs ==="
          docker logs gl-postgres || true
          echo "=== NATS Logs ==="
          docker logs nats || true

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.modules.yml down || true
          docker compose -f docker-compose.infrastructure.yml down || true
