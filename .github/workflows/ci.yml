name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate-contracts:
    name: Validate Contracts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate YAML contracts
        run: |
          python3 -c "
          import yaml
          import sys
          from pathlib import Path
          
          errors = []
          for f in Path('contracts').rglob('*.yaml'):
              try:
                  yaml.safe_load(f.read_text())
                  print(f'✓ {f}')
              except Exception as e:
                  errors.append(f'✗ {f}: {e}')
          
          if errors:
              for e in errors:
                  print(e, file=sys.stderr)
              sys.exit(1)
          "
      
      - name: Validate JSON contracts
        run: |
          python3 -c "
          import json
          import sys
          from pathlib import Path
          
          errors = []
          for f in Path('contracts').rglob('*.json'):
              try:
                  json.loads(f.read_text())
                  print(f'✓ {f}')
              except Exception as e:
                  errors.append(f'✗ {f}: {e}')
          
          if errors:
              for e in errors:
                  print(e, file=sys.stderr)
              sys.exit(1)
          "

  validate-module-structure:
    name: Validate Module Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check VERSION and CHANGELOG exist
        run: |
          missing=()

          for module in platform/identity-auth modules/ar modules/subscriptions modules/payments modules/notifications; do
            if [ ! -f "$module/VERSION" ]; then
              missing+=("$module/VERSION")
            fi
            if [ ! -f "$module/CHANGELOG.md" ]; then
              missing+=("$module/CHANGELOG.md")
            fi
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "ERROR: Missing required files:" >&2
            printf '%s\n' "${missing[@]}" >&2
            exit 1
          fi

          echo "✓ All modules have VERSION and CHANGELOG.md"

  contract-tests:
    name: Contract Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-contract-tests-${{ hashFiles('tools/contract-tests/Cargo.lock') }}

      - name: Run contract tests
        working-directory: tools/contract-tests
        run: cargo test --verbose

  cross-module-boundary-guard:
    name: Cross-Module Boundary Guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for illegal cross-module source imports
        run: |
          violations=()
          
          # AR must not reference AUTH source paths
          if grep -r "platform/identity-auth/src" modules/ar/src/ 2>/dev/null; then
            violations+=("AR references AUTH source code")
          fi
          
          # AUTH must not reference AR source paths
          if grep -r "modules/ar/src" platform/identity-auth/src/ 2>/dev/null; then
            violations+=("AUTH references AR source code")
          fi
          
          if [ ${#violations[@]} -gt 0 ]; then
            echo "ERROR: Cross-module boundary violations detected:" >&2
            printf '%s\n' "${violations[@]}" >&2
            exit 1
          fi
          
          echo "✓ No cross-module source code dependencies"
      
      - name: Check for illegal cross-module Cargo path dependencies
        run: |
          violations=()
          
          # Check AUTH Cargo.toml for path deps to other modules
          if grep -n 'path = .*\.\./\.\./\(modules\|platform\)' platform/identity-auth/Cargo.toml; then
            violations+=("AUTH has cross-module path dependency")
          fi
          
          if grep -n 'path = .*\.\./modules' platform/identity-auth/Cargo.toml; then
            violations+=("AUTH has cross-module path dependency")
          fi
          
          # Check AR Cargo.toml for path deps to other modules
          if grep -n 'path = .*\.\./\.\./\(modules\|platform\)' modules/ar/Cargo.toml; then
            violations+=("AR has cross-module path dependency")
          fi
          
          if grep -n 'path = .*\.\./platform' modules/ar/Cargo.toml; then
            violations+=("AR has cross-module path dependency")
          fi
          
          if [ ${#violations[@]} -gt 0 ]; then
            echo "ERROR: Cross-module Cargo path dependencies detected:" >&2
            printf '%s\n' "${violations[@]}" >&2
            echo "" >&2
            echo "Modules must not use 'path' dependencies to other modules." >&2
            echo "Use versioned crates or duplicate code instead." >&2
            exit 1
          fi
          
          echo "✓ No cross-module Cargo path dependencies"
      
      - name: Check migration boundaries
        run: |
          chmod +x tools/check_migration_boundaries.sh
          ./tools/check_migration_boundaries.sh

  build-auth:
    name: Build AUTH Module
    runs-on: ubuntu-latest
    needs: [contract-tests]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-auth-${{ hashFiles('platform/identity-auth/Cargo.lock') }}
      
      - name: Run cargo check
        working-directory: platform/identity-auth
        run: cargo check --all-targets

  build-ar:
    name: Build AR Module
    runs-on: ubuntu-latest
    needs: [contract-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-ar-${{ hashFiles('modules/ar/Cargo.lock') }}

      - name: Run cargo check
        working-directory: modules/ar
        run: cargo check --all-targets

  build-subscriptions:
    name: Build Subscriptions Module
    runs-on: ubuntu-latest
    needs: [contract-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-subscriptions-${{ hashFiles('modules/subscriptions/Cargo.lock') }}

      - name: Run cargo check
        working-directory: modules/subscriptions
        run: cargo check --all-targets

  build-payments:
    name: Build Payments Module
    runs-on: ubuntu-latest
    needs: [contract-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-payments-${{ hashFiles('modules/payments/Cargo.lock') }}

      - name: Run cargo check
        working-directory: modules/payments
        run: cargo check --all-targets

  build-notifications:
    name: Build Notifications Module
    runs-on: ubuntu-latest
    needs: [contract-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-notifications-${{ hashFiles('modules/notifications/Cargo.lock') }}

      - name: Run cargo check
        working-directory: modules/notifications
        run: cargo check --all-targets
