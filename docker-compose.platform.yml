name: 7d-platform

services:
  # =========================
  # IDENTITY & AUTH (2 instances)
  # =========================
  auth-1:
    container_name: 7d-auth-1
    build:
      context: ./platform/identity-auth
      dockerfile: deploy/Dockerfile
    restart: unless-stopped
    environment:
      DATABASE_URL: postgres://${AUTH_POSTGRES_USER:-auth_user}:${AUTH_POSTGRES_PASSWORD:-auth_pass}@7d-auth-postgres:5432/${AUTH_POSTGRES_DB:-auth_db}
      NATS_URL: nats://7d-nats:4222
      HOST: 0.0.0.0
      PORT: 8080
      JWT_PRIVATE_KEY_PEM: ${JWT_PRIVATE_KEY_PEM}
      JWT_PUBLIC_KEY_PEM: ${JWT_PUBLIC_KEY_PEM}
      JWT_KID: ${JWT_KID:-auth-key-1}
      ACCESS_TOKEN_TTL_MINUTES: "15"
      REFRESH_TOKEN_TTL_DAYS: "14"
      ARGON_MEMORY_KB: "65536"
      ARGON_ITERATIONS: "3"
      ARGON_PARALLELISM: "1"
      MAX_CONCURRENT_HASHES: "50"
      HASH_ACQUIRE_TIMEOUT_MS: "5000"
      LOCKOUT_THRESHOLD: "10"
      LOCKOUT_MINUTES: "15"
      LOGIN_PER_MIN_PER_EMAIL: "5"
      REGISTER_PER_MIN_PER_EMAIL: "5"
      REFRESH_PER_MIN_PER_TOKEN: "20"
      RUST_LOG: info,auth_rs=debug
    networks:
      - 7d-platform
    # Depends on auth-postgres and nats from 7d-infrastructure
    labels:
      com.7dsolutions.project: "platform"
      com.7dsolutions.tier: "platform"
      com.7dsolutions.component: "auth"
      com.7dsolutions.type: "api"
      com.7dsolutions.env: "dev"
      com.7dsolutions.instance: "1"

  auth-2:
    container_name: 7d-auth-2
    build:
      context: ./platform/identity-auth
      dockerfile: deploy/Dockerfile
    restart: unless-stopped
    environment:
      DATABASE_URL: postgres://${AUTH_POSTGRES_USER:-auth_user}:${AUTH_POSTGRES_PASSWORD:-auth_pass}@7d-auth-postgres:5432/${AUTH_POSTGRES_DB:-auth_db}
      NATS_URL: nats://7d-nats:4222
      HOST: 0.0.0.0
      PORT: 8080
      JWT_PRIVATE_KEY_PEM: ${JWT_PRIVATE_KEY_PEM}
      JWT_PUBLIC_KEY_PEM: ${JWT_PUBLIC_KEY_PEM}
      JWT_KID: ${JWT_KID:-auth-key-1}
      ACCESS_TOKEN_TTL_MINUTES: "15"
      REFRESH_TOKEN_TTL_DAYS: "14"
      ARGON_MEMORY_KB: "65536"
      ARGON_ITERATIONS: "3"
      ARGON_PARALLELISM: "1"
      MAX_CONCURRENT_HASHES: "50"
      HASH_ACQUIRE_TIMEOUT_MS: "5000"
      LOCKOUT_THRESHOLD: "10"
      LOCKOUT_MINUTES: "15"
      LOGIN_PER_MIN_PER_EMAIL: "5"
      REGISTER_PER_MIN_PER_EMAIL: "5"
      REFRESH_PER_MIN_PER_TOKEN: "20"
      RUST_LOG: info,auth_rs=debug
    networks:
      - 7d-platform
    # Depends on auth-postgres and nats from 7d-infrastructure
    labels:
      com.7dsolutions.project: "platform"
      com.7dsolutions.tier: "platform"
      com.7dsolutions.component: "auth"
      com.7dsolutions.type: "api"
      com.7dsolutions.env: "dev"
      com.7dsolutions.instance: "2"

  # =========================
  # AUTH LOAD BALANCER
  # =========================
  auth-lb:
    container_name: 7d-auth-lb
    image: nginx:alpine
    restart: unless-stopped
    volumes:
      - ./nginx/auth-nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "8080:80"
    networks:
      - 7d-platform
    depends_on:
      - auth-1
      - auth-2
    labels:
      com.7dsolutions.project: "platform"
      com.7dsolutions.tier: "platform"
      com.7dsolutions.component: "auth-lb"
      com.7dsolutions.type: "proxy"
      com.7dsolutions.env: "dev"

networks:
  7d-platform:
    name: 7d-platform
    external: true
